<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>لوحة الإدارة - توليد مفاتيح طبيبي</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');

    /* box-sizing عام للتحكم في العرض */
    *, *::before, *::after { box-sizing: border-box; }

    /* CSS Variables للـThemes (مشابه لـ dashboard.html) */
    :root {
      --bg-color: #f5f7fa;
      --card-bg: #ffffff;
      --text-color: #333;
      --secondary-text: #666;
      --border-color: #d1d5db;
      --primary-blue: #1e88e5;
      --button-bg: #1e88e5;
      --button-hover: #1565c0;
      --secondary-button-bg: #f1f1f1;
      --secondary-button-hover: #ddd;
      --success-green: #4caf50;
      --warning-orange: #ff9800;
      --error-red: #f44336;
      --shadow-light: rgba(0,0,0,0.05);
      --icon-color: #1e88e5;
    }

    [data-theme="dark"] {
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #e0e0e0;
      --secondary-text: #b0b0b0;
      --border-color: #4b5563;
      --primary-blue: #0d47a1;
      --button-bg: #0d47a1;
      --button-hover: #1565c0;
      --secondary-button-bg: #2a2a2a;
      --secondary-button-hover: #3a3a3a;
      --success-green: #388e3c;
      --warning-orange: #ff8f00;
      --error-red: #ef5350;
      --shadow-light: rgba(255,255,255,0.05);
      --icon-color: #90caf9;
    }

    body {
      margin: 0;
      font-family: 'Tajawal', sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      transition: background-color 0.3s, color 0.3s;
    }

    /* منع تحديد النص */
    * { user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
    input, textarea, select, button { user-select: text; -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; }

    header {
      background: var(--primary-blue);
      color: #fff;
      padding: 15px 20px;
      display: flex;
      flex-direction: column; /* افتراضي column للهواتف */
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 2px 8px var(--shadow-light);
      text-align: center;
    }

    header h1 {
      font-size: 24px;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    header small {
      font-size: 13px;
      margin-top: 2px;
    }

    /* زر الثيم */
    #themeToggle {
      background: var(--secondary-button-bg);
      color: var(--text-color);
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
      display: flex;
      align-items: center;
      gap: 5px;
      width: 100%;
      max-width: 200px;
      justify-content: center;
    }

    #themeToggle:hover { background: var(--secondary-button-hover); }

    main {
      flex: 1;
      padding: 20px;
      width: 100%;
      max-width: 100%; /* تحسين: ليس 800px على هواتف */
      margin: 0 auto;
    }

    .card {
      background: var(--card-bg);
      padding: 20px;
      margin: 20px 0;
      border-radius: 12px;
      box-shadow: 0 2px 8px var(--shadow-light);
      transition: background-color 0.3s;
    }

    .card h2 { margin-top: 0; color: var(--primary-blue); }

    /* Form: stacked labels/input على هواتف */
    .card label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: var(--text-color);
    }

    .card input, .card select {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin: 5px 0 15px 0; /* تحسين: مسافة أقل */
      font-family: inherit;
      background: var(--card-bg);
      color: var(--text-color);
      font-size: 16px; /* للهواتف: أكبر لللمس */
    }

    .card input:focus, .card select:focus { outline: none; border-color: var(--primary-blue); }

    .btn {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background-color 0.3s;
    }

    .btn-primary { background: var(--button-bg); color: #fff; }
    .btn-primary:hover { background: var(--button-hover); }
    .btn-primary:disabled { background: var(--secondary-button-bg); cursor: not-allowed; color: var(--secondary-text); }

    .btn-success { background: var(--success-green); color: #fff; }
    .btn-success:hover { background: #388e3c; }

    .btn-clear { background: var(--secondary-button-bg); color: var(--text-color); width: auto; padding: 8px 16px; margin-left: 10px; }
    .btn-clear:hover { background: var(--secondary-button-hover); }

    /* زر النسخ في الجدول */
    .copy-btn {
      background: var(--success-green);
      color: #fff;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
    }

    .copy-btn:hover { background: #388e3c; }
    .copy-btn:active { transform: scale(0.98); }

    .status-message {
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: bold;
      text-align: center;
    }

    .status-success { background: rgba(76, 175, 80, 0.1); color: var(--success-green); border: 1px solid var(--success-green); }
    .status-error { background: rgba(244, 67, 54, 0.1); color: var(--error-red); border: 1px solid var(--error-red); }

    /* إحصائيات: عمود واحد على هواتف */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr; /* افتراضي 1fr للهواتف */
      gap: 10px;
      margin: 15px 0;
    }

    .stat-card {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px var(--shadow-light);
    }

    .stat-number { font-size: 24px; font-weight: bold; color: var(--primary-blue); }
    .stat-label { font-size: 14px; color: var(--secondary-text); }

    /* شريط الفلتر: flex-wrap مع stack على هواتف */
    #filterSection {
      display: flex;
      flex-direction: column; /* افتراضي column للهواتف */
      gap: 10px;
      margin: 15px 0;
      padding: 10px;
      background: var(--secondary-button-bg);
      border-radius: 8px;
      align-items: stretch;
    }

    #filterSearch { width: 100%; }
    #filterSection input, #filterSection select {
      flex: none;
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      background: var(--card-bg);
      color: var(--text-color);
      font-size: 16px;
    }

    #filterResults { 
      margin-top: 5px; 
      font-size: 12px; 
      color: var(--secondary-text); 
      text-align: center; 
    }

    #clearFilters { 
      align-self: center; 
      margin-top: 10px; 
      width: auto; 
    }

    #noResults { text-align: center; padding: 20px; color: var(--secondary-text); font-style: italic; }

    /* جدول: horizontal scroll + تقليل عرض */
    #keysContainer {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin: 10px 0;
      overflow-x: auto; /* تحسين: scroll أفقي للجدول على هواتف */
    }

    table { width: 100%; border-collapse: collapse; min-width: 600px; /* min-width للتمرير الأفقي */ }
    th, td { 
      padding: 10px; 
      text-align: right; 
      border-bottom: 1px solid var(--border-color); 
      min-width: 70px; /* تحسين: أضيق للهواتف */
      white-space: nowrap; /* منع كسر النصوص الطويلة مثل المفتاح */
    }
    th { background: var(--secondary-button-bg); color: var(--text-color); position: sticky; top: 0; z-index: 1; }
    .expired { color: var(--error-red); }
    .activated { color: var(--success-green); }

    /* Generated Keys textarea */
    #generatedKeys textarea {
      width: 100%; 
      height: 150px; 
      padding: 10px; 
      border: 1px solid var(--border-color); 
      border-radius: 8px; 
      font-family: monospace; 
      direction: ltr; 
      text-align: left;
      resize: vertical; /* السماح بتعديل الارتفاع */
    }

    /* Loading */
    .loading { display: inline-block; width: 20px; height: 20px; border: 3px solid var(--border-color); border-radius: 50%; border-top-color: var(--primary-blue); animation: spin 1s infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive Media Queries (محسنة للهواتف) */
    @media (max-width: 480px) { 
      header { padding: 10px; font-size: 14px; }
      header h1 { font-size: 20px; gap: 5px; }
      main { padding: 5px; }
      .card { padding: 15px; margin: 10px 0; }
      .card input, .card select { padding: 10px; font-size: 16px; margin: 5px 0; }
      .btn { padding: 12px; font-size: 16px; }
      .stats-grid { gap: 8px; }
      .stat-number { font-size: 20px; }
      .stat-label { font-size: 12px; }
      #keysContainer { max-height: 300px; }
      table th, table td { padding: 6px; font-size: 11px; min-width: 60px; }
      #generatedKeys textarea { height: 100px; font-size: 12px; }
      #filterSection { padding: 8px; gap: 8px; }
      #filterSection input, #filterSection select { padding: 10px; }
      .btn-clear { width: 100%; margin-top: 5px; }
      #filterResults { font-size: 11px; }
      .copy-btn { padding: 4px 8px; font-size: 10px; }
    }

    @media (min-width: 481px) and (max-width: 768px) { 
      header { flex-direction: row; justify-content: space-between; padding: 12px 15px; }
      #themeToggle { width: auto; max-width: none; }
      main { padding: 10px; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      #filterSection { flex-direction: row; flex-wrap: wrap; }
      #filterSearch { flex: 2; min-width: 150px; }
      #filterSection select { min-width: 120px; }
      #keysContainer { max-height: 350px; }
      table th, table td { padding: 8px; font-size: 12px; min-width: 80px; }
    }

    @media (min-width: 769px) { 
      header { flex-direction: row; justify-content: space-between; }
      main { max-width: 800px; padding: 20px; }
      .stats-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
      #filterSection { flex-direction: row; align-items: center; }
      table th, table td { min-width: 100px; }
    }

    /* Dark Mode تحسينات */
    [data-theme="dark"] input, [data-theme="dark"] select { background: var(--card-bg); color: var(--text-color); border-color: var(--border-color); }
    [data-theme="dark"] table th { background: var(--secondary-button-bg); }
    [data-theme="dark"] .copy-btn { background: var(--success-green); }
    [data-theme="dark"] #keysContainer { border-color: var(--border-color); }
    [data-theme="dark"] #filterSection { background: var(--secondary-button-bg); }
  </style>
</head>
<body data-theme="light">

  <header>
    <h1><i class="fas fa-cogs"></i> لوحة الإدارة - طبيبي</h1>
    <button id="themeToggle">
      <i class="fas fa-moon"></i> وضع الليل
    </button>
  </header>

  <main>
    <div class="card">
      <h2><i class="fas fa-key"></i> توليد مفاتيح اشتراك جديدة</h2>
      <form id="generateForm">
        <label>عدد المفاتيح:</label>
        <input type="number" id="numKeys" min="1" max="1000" value="10" required>

        <label>نوع الاشتراك:</label>
        <select id="subscriptionType" required>
          <option value="minute">دقيقة (للاختبار)</option>
          <option value="month" selected>شهر واحد</option>
          <option value="2months">شهرين</option>
          <option value="year">سنة واحدة</option>
          <option value="2years">سنتين</option>
        </select>

        <label>عدد الأجهزة المسموحة لكل مفتاح:</label>
        <input type="number" id="maxDevices" min="1" max="10" value="1" required>

        <button type="submit" class="btn btn-primary" id="generateBtn">
          <i class="fas fa-magic"></i> توليد المفاتيح
        </button>
      </form>
      <div id="generateStatus"></div>
      <div id="generatedKeys" style="margin-top: 20px; display: none;">
        <h3>المفاتيح المولدة:</h3>
        <textarea readonly style="width: 100%; height: 150px; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; font-family: monospace; direction: ltr; text-align: left;"></textarea>
      </div>
    </div>

    <div class="card">
      <h2><i class="fas fa-chart-bar"></i> إحصائيات المفاتيح</h2>
      <div class="stats-grid" id="statsGrid">
        <!-- سيتم ملؤها ديناميكيًا -->
      </div>
      <div class="loading" id="statsLoading"></div>

      <!-- شريط الفلتر (مع تحسين responsive) -->
      <div id="filterSection">
        <input type="text" id="filterSearch" placeholder="ابحث بالمفتاح (مثل TABIBI-ABCD)..." style="direction: ltr;">
        <select id="filterStatus">
          <option value="">جميع الحالات</option>
          <option value="inactive">غير مفعل</option>
          <option value="active">مفعل</option>
          <option value="expired">منتهي</option>
        </select>
        <select id="filterType">
          <option value="">جميع الأنواع</option>
          <option value="minute">دقيقة (للاختبار)</option>
          <option value="month">شهر واحد</option>
          <option value="2months">شهرين</option>
          <option value="year">سنة واحدة</option>
          <option value="2years">سنتين</option>
        </select>
        <button class="btn-clear" id="clearFilters"><i class="fas fa-times"></i> مسح</button>
        <div id="filterResults"></div>
      </div>

      <div id="keysContainer">
        <table id="keysTable">
          <thead>
            <tr><th>المفتاح</th><th>نوع</th><th>أجهزة حالية/الحد الأقصى</th><th>تاريخ التوليد</th><th>تاريخ التفعيل</th><th>انتهاء</th><th>حالة</th><th>إجراءات</th></tr>
          </thead>
          <tbody id="keysTableBody"></tbody>
        </table>
        <div id="noResults" style="display: none;">لا توجد نتائج مطابقة</div>
      </div>
    </div>
  </main>

  <footer style="text-align: center; padding: 15px; background: var(--primary-blue); color: #fff; font-size: 14px;">© جميع الحقوق محفوظة لـ Kasp-ai</footer>

  <!-- Firebase SDK (تصحيح: استخدم config الأصلي الذي عمل سابقًا) -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getDatabase, ref, get, set, update } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

    const config = {
      apiKey: "AIzaSyAVmar5Wz9bECnRUSu7XwUNKnnqG3b6Wwc",
      authDomain: "subscription-key-tsbibisy.firebaseapp.com",
      databaseURL: "https://subscription-key-tsbibisy-default-rtdb.firebaseio.com",
      projectId: "subscription-key-tsbibisy",
      storageBucket: "subscription-key-tsbibisy.firebasestorage.app",
      messagingSenderId: "870064790159",
      appId: "1:870064790159:web:03da3ce667350dcc3a6efa"
    };

    const app = initializeApp(config);
    const db = getDatabase(app);

    // باقي JS كما في الإصدار السابق (فلتر، updateStats مع عرض الجميع، etc.)
    // عناصر DOM
    const generateForm = document.getElementById('generateForm');
    const numKeysInput = document.getElementById('numKeys');
    const subscriptionTypeSelect = document.getElementById('subscriptionType');
    const maxDevicesInput = document.getElementById('maxDevices');
    const generateBtn = document.getElementById('generateBtn');
    const generateStatus = document.getElementById('generateStatus');
    const generatedKeysDiv = document.getElementById('generatedKeys');
    const keysTextarea = generatedKeysDiv.querySelector('textarea');
    const statsGrid = document.getElementById('statsGrid');
    const statsLoading = document.getElementById('statsLoading');
    const keysTableBody = document.getElementById('keysTableBody');
    const noResultsDiv = document.getElementById('noResults');

    // فلاتر
    const filterSearch = document.getElementById('filterSearch');
    const filterStatus = document.getElementById('filterStatus');
    const filterType = document.getElementById('filterType');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const filterResults = document.getElementById('filterResults');

    let allKeysData = [];  // تخزين البيانات الأصلية
    let debounceTimer;  // للبحث

    // توليد مفتاح (غير)
    function generateKey() {
      const prefix = 'TABIBI-';
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let random = '';
      for (let i = 0; i < 14; i++) {  // 14 خانة عشوائية
        random += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      // مجزأة الـ14 خانة بـ "-" : 4-4-4-2
      const formattedRandom = [
        random.substring(0, 4),
        random.substring(4, 8),
        random.substring(8, 12),
        random.substring(12, 14)
      ].join('-');
      return prefix + formattedRandom;  // مثل: TABIBI-ABCD-EFGH-IJKL-MN
    }

    // التحقق من عدم تكرار المفتاح (غير)
    async function isKeyUnique(key) {
      const keyRef = ref(db, `keys/${key}`);
      const snapshot = await get(keyRef);
      return !snapshot.exists();
    }

    // توليد keys فريدة (غير)
    async function generateUniqueKeys(count) {
      const keys = [];
      while (keys.length < count) {
        const key = generateKey();
        if (await isKeyUnique(key)) {
          keys.push(key);
        }
      }
      return keys;
    }

    // حساب المدة (غير)
    function getDuration(type) {
      const durations = {
        'minute': 1 * 60 * 1000,
        'month': 30 * 24 * 60 * 60 * 1000,
        '2months': 60 * 24 * 60 * 60 * 1000,
        'year': 365 * 24 * 60 * 60 * 1000,
        '2years': 730 * 24 * 60 * 60 * 1000
      };
      return durations[type] || 0;
    }

    // تنسيق التاريخ (غير)
    function formatDate(timestamp) {
      if (!timestamp) return 'غير محدد';
      try {
        const date = new Date(timestamp);
        const options = { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric', 
          hour: '2-digit', 
          minute: '2-digit',
          calendar: 'gregorian'  // ميلادي
        };
        return date.toLocaleDateString('ar-SA-u-ca-gregorian', options) || date.toLocaleDateString('en-US', options).replace(/Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec/g, m => ['يناير','فبراير','مارس','أبريل','مايو','يونيو','يوليو','أغسطس','سبتمبر','أكتوبر','نوفمبر','ديسمبر'][['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'].indexOf(m)]);
      } catch (e) {
        return new Date(timestamp).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      }
    }

    // نسخ إلى clipboard (غير)
    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (err) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        return true;
      }
    }

    // تطبيق الفلاتر (غير، مع debounce للهواتف)
    function applyFilters(keysArray) {
      let filtered = [...keysArray];

      const searchTerm = filterSearch.value.trim().toUpperCase();
      if (searchTerm) {
        filtered = filtered.filter(item => item.key.toUpperCase().includes(searchTerm));
      }

      const statusFilter = filterStatus.value;
      if (statusFilter) {
        filtered = filtered.filter(item => {
          const isActivated = item.activated;
          const isExpired = isActivated && item.expirationTime && item.expirationTime <= Date.now();
          if (statusFilter === 'inactive' && !isActivated) return true;
          if (statusFilter === 'active' && isActivated && !isExpired) return true;
          if (statusFilter === 'expired' && isExpired) return true;
          return false;
        });
      }

      const typeFilter = filterType.value;
      if (typeFilter) {
        filtered = filtered.filter(item => item.subscriptionType === typeFilter);
      }

      return filtered;
    }

    // تحديث الجدول (غير، عرض الجميع مع scroll)
    function renderTable(filteredKeys) {
      keysTableBody.innerHTML = '';
      if (filteredKeys.length === 0) {
        noResultsDiv.style.display = 'block';
        return;
      }
      noResultsDiv.style.display = 'none';

      filteredKeys.forEach(({ key, subscriptionType, maxDevices, currentDevices = 0, generatedTime, activationTime, expirationTime, activated }) => {
        const isExpired = activated && expirationTime && expirationTime <= Date.now();
        const statusClass = activated ? (isExpired ? 'expired' : 'activated') : '';
        const statusText = activated ? (isExpired ? 'منتهي' : 'مفعل') : 'غير مفعل';
        const devicesText = `${currentDevices || 0}/${maxDevices || 1}`;

        const copyBtnHtml = `<button class="copy-btn" onclick="copyToClipboard('${key}'); this.innerHTML='<i class=\'fas fa-check\'></i> تم النسخ!'; setTimeout(() => this.innerHTML='<i class=\'fas fa-copy\'></i> نسخ', 2000);"><i class="fas fa-copy"></i> نسخ</button>`;

        const row = document.createElement('tr');
        row.innerHTML = `
          <td style="font-family: monospace; direction: ltr;">${key}</td>
          <td>${subscriptionType}</td>
          <td>${devicesText}</td>
          <td>${formatDate(generatedTime)}</td>
          <td>${formatDate(activationTime)}</td>
          <td>${formatDate(expirationTime)}</td>
          <td class="${statusClass}">${statusText}</td>
          <td>${copyBtnHtml}</td>
        `;
        keysTableBody.appendChild(row);
      });
    }

    // عرض الإحصائيات (تحديث مع عرض الجميع)
    async function updateStats() {
      statsLoading.style.display = 'inline-block';
      try {
        const keysRef = ref(db, 'keys');
        const snapshot = await get(keysRef);
        if (!snapshot.exists()) {
          statsGrid.innerHTML = '<p>لا توجد مفاتيح.</p>';
          keysTableBody.innerHTML = '';
          filterResults.textContent = '';
          return;
        }

        const allKeys = snapshot.val();
        allKeysData = Object.entries(allKeys).map(([key, data]) => ({ key, ...data }));

        // ترتيب تنازلي حسب تاريخ التوليد (أحدث أولاً)
        allKeysData.sort((a, b) => (b.generatedTime || 0) - (a.generatedTime || 0));

        const totalGenerated = allKeysData.length;
        const activated = allKeysData.filter(k => k.activated).length;
        const expired = allKeysData.filter(k => k.activated && k.expirationTime && k.expirationTime <= Date.now()).length;

        // تحديث الإحصائيات
        statsGrid.innerHTML = `
          <div class="stat-card">
            <div class="stat-number">${totalGenerated}</div>
            <div class="stat-label">مولدة</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${activated}</div>
            <div class="stat-label">مفعلة</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${expired}</div>
            <div class="stat-label">منتهية</div>
          </div>
        `;

        // تطبيق الفلتر وتحديث الجدول
        const filteredKeys = applyFilters(allKeysData);
        renderTable(filteredKeys);
        filterResults.textContent = `يتم عرض ${filteredKeys.length} من ${totalGenerated} مفتاح`;

      } catch (error) {
        console.error('خطأ في الإحصائيات:', error);
        statsGrid.innerHTML = '<p class="status-error">خطأ في تحميل الإحصائيات.</p>';
        keysTableBody.innerHTML = '';
        filterResults.textContent = '';
      } finally {
        statsLoading.style.display = 'none';
      }
    }

    // معالج التوليد (غير)
    generateForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const numKeys = parseInt(numKeysInput.value);
      const subscriptionType = subscriptionTypeSelect.value;
      const maxDevices = parseInt(maxDevicesInput.value);
      const duration = getDuration(subscriptionType);

      if (numKeys > 1000) {
        showStatus('الحد الأقصى 1000 مفتاح.', 'error');
        return;
      }

      generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التوليد...';
      generateBtn.disabled = true;

      try {
        const keys = await generateUniqueKeys(numKeys);
        const generatedData = [];

        for (const key of keys) {
          const keyRef = ref(db, `keys/${key}`);
          await set(keyRef, {
            subscriptionType,
            maxDevices,
            currentDevices: 0,
            deviceIds: [],
            generatedTime: Date.now(),
            activated: false,
            activationTime: null,
            expirationTime: null  // يُحسب عند أول تفعيل
          });
          generatedData.push(key);
        }

        keysTextarea.value = generatedData.join('\n');
        generatedKeysDiv.style.display = 'block';
        showStatus(`تم توليد ${numKeys} مفتاح بنجاح! (نوع: ${subscriptionType}, أجهزة: ${maxDevices})`, 'success');

        // تحديث الإحصائيات فورًا (مع تطبيق الفلتر الحالي)
        await updateStats();

      } catch (error) {
        console.error('خطأ في التوليد:', error);
        showStatus('خطأ: ' + error.message, 'error');
      } finally {
        generateBtn.innerHTML = '<i class="fas fa-magic"></i> توليد المفاتيح';
        generateBtn.disabled = false;
      }
    });

    // معالجات الفلاتر (تلقائية، مع debounce)
    function debounceFilter() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => updateStats(), 300);
    }

    filterSearch.addEventListener('input', debounceFilter);
    filterStatus.addEventListener('change', updateStats);
    filterType.addEventListener('change', updateStats);

    // مسح الفلاتر
    clearFiltersBtn.addEventListener('click', () => {
      filterSearch.value = '';
      filterStatus.value = '';
      filterType.value = '';
      updateStats();
    });

    // عرض الرسائل (غير)
    function showStatus(message, type) {
      generateStatus.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
      setTimeout(() => { generateStatus.innerHTML = ''; }, 5000);
    }

    // تهيئة الصفحة (غير)
    document.addEventListener('DOMContentLoaded', () => {
      updateStats();  // تحميل أولي
      setInterval(updateStats, 5000);  // تحديث كل 5 ثوانٍ
    });
  </script>

  <script>
    // Dark/Light Mode Toggle (غير)
    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const toggleBtn = document.getElementById('themeToggle');
      const icon = toggleBtn.querySelector('i');
      const text = theme === 'dark' ? 'وضع النهار' : 'وضع الليل';
      icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      toggleBtn.innerHTML = `${icon.outerHTML} ${text}`;
    }

    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);

    themeToggle.addEventListener('click', () => {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      applyTheme(newTheme);
    });

    // منع الضغط المطول والسياق (غير)
    document.addEventListener('DOMContentLoaded', function() {
      const links = document.querySelectorAll('a');
      links.forEach(link => {
        link.addEventListener('contextmenu', e => e.preventDefault());
        let longPressTimer;
        link.addEventListener('touchstart', e => {
          if (e.touches.length > 0) {
            longPressTimer = setTimeout(() => e.preventDefault(), 500);
          }
        });
        link.addEventListener('touchend', () => clearTimeout(longPressTimer));
        link.addEventListener('touchmove', () => clearTimeout(longPressTimer));
      });
    });

    // جعل copyToClipboard متاحة عالميًا (غير)
    window.copyToClipboard = copyToClipboard;
  </script>

</body>
</html>
